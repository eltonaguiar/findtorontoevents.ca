<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Engine Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #4ecca3; }
        .section {
            background: #16213e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        button {
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #3db892; }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .status.success { background: #2d5a3d; }
        .status.error { background: #5a2d3d; }
        .status.info { background: #3d4a5a; }
        .meter {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecca3, #e74c3c);
            width: 0%;
            transition: width 0.1s;
        }
        .peer-list {
            list-style: none;
            padding: 0;
        }
        .peer-item {
            background: #0f3460;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }
        .log {
            background: #0a0a0a;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
        }
        .log-entry.info { color: #4ecca3; }
        .log-entry.error { color: #e74c3c; }
        .log-entry.warn { color: #f39c12; }
    </style>
</head>
<body>
    <h1>üéôÔ∏è Voice Engine Test</h1>
    
    <div class="section">
        <h2>Connection Status</h2>
        <div id="connectionStatus" class="status info">Not initialized</div>
        <button id="btnInit">Initialize VoiceEngine</button>
        <button id="btnDestroy" disabled>Destroy</button>
    </div>

    <div class="section">
        <h2>Zone Management</h2>
        <div id="zoneStatus" class="status info">Not in any zone</div>
        <button id="btnJoinEvents" disabled>Join Events Zone</button>
        <button id="btnJoinMovies" disabled>Join Movies Zone</button>
        <button id="btnLeave" disabled>Leave Zone</button>
    </div>

    <div class="section">
        <h2>Audio Controls</h2>
        <div id="muteStatus" class="status info">Muted: true</div>
        <button id="btnToggleMute" disabled>Toggle Mute</button>
        <button id="btnPushToTalk" disabled>Push-to-Talk (Hold)</button>
        <button id="btnEnablePTT" disabled>Enable PTT Mode</button>
    </div>

    <div class="section">
        <h2>Voice Activity Detection</h2>
        <div class="meter">
            <div id="audioMeter" class="meter-fill"></div>
        </div>
        <div id="vadStatus">Speaking: false | Level: 0%</div>
    </div>

    <div class="section">
        <h2>Spatial Audio</h2>
        <div>
            Position: X: <input type="number" id="posX" value="0" step="0.1" style="width: 60px;">
            Y: <input type="number" id="posY" value="0" step="0.1" style="width: 60px;">
            Z: <input type="number" id="posZ" value="0" step="0.1" style="width: 60px;">
            <button id="btnUpdatePos" disabled>Update Position</button>
        </div>
        <div style="margin-top: 10px;">
            Proximity Radius: <input type="range" id="proximityRadius" min="1" max="50" value="10" style="width: 200px;">
            <span id="radiusValue">10m</span>
            <button id="btnSetRadius" disabled>Set Radius</button>
        </div>
    </div>

    <div class="section">
        <h2>Connected Peers (<span id="peerCount">0</span>)</h2>
        <ul id="peerList" class="peer-list">
            <li class="peer-item">No peers connected</li>
        </ul>
    </div>

    <div class="section">
        <h2>Event Log</h2>
        <div id="log" class="log"></div>
        <button id="btnClearLog">Clear Log</button>
    </div>

    <script src="voice-engine.js"></script>
    <script>
        // DOM Elements
        const connectionStatus = document.getElementById('connectionStatus');
        const zoneStatus = document.getElementById('zoneStatus');
        const muteStatus = document.getElementById('muteStatus');
        const audioMeter = document.getElementById('audioMeter');
        const vadStatus = document.getElementById('vadStatus');
        const peerList = document.getElementById('peerList');
        const peerCount = document.getElementById('peerCount');
        const log = document.getElementById('log');
        const radiusValue = document.getElementById('radiusValue');

        // Buttons
        const btnInit = document.getElementById('btnInit');
        const btnDestroy = document.getElementById('btnDestroy');
        const btnJoinEvents = document.getElementById('btnJoinEvents');
        const btnJoinMovies = document.getElementById('btnJoinMovies');
        const btnLeave = document.getElementById('btnLeave');
        const btnToggleMute = document.getElementById('btnToggleMute');
        const btnPushToTalk = document.getElementById('btnPushToTalk');
        const btnEnablePTT = document.getElementById('btnEnablePTT');
        const btnUpdatePos = document.getElementById('btnUpdatePos');
        const btnSetRadius = document.getElementById('btnSetRadius');
        const btnClearLog = document.getElementById('btnClearLog');
        const proximityRadius = document.getElementById('proximityRadius');

        let isInitialized = false;
        let pttEnabled = false;

        // Logging
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Update UI state
        function updateUI() {
            const connected = VoiceEngine.isConnected();
            const currentZone = VoiceEngine.getCurrentZone();
            const muted = VoiceEngine.isMuted();

            btnInit.disabled = isInitialized;
            btnDestroy.disabled = !isInitialized;
            btnJoinEvents.disabled = !isInitialized || currentZone;
            btnJoinMovies.disabled = !isInitialized || currentZone;
            btnLeave.disabled = !isInitialized || !currentZone;
            btnToggleMute.disabled = !isInitialized;
            btnPushToTalk.disabled = !isInitialized || !pttEnabled;
            btnEnablePTT.disabled = !isInitialized;
            btnUpdatePos.disabled = !isInitialized;
            btnSetRadius.disabled = !isInitialized;

            connectionStatus.textContent = connected ? 'Connected to signaling server' : 'Disconnected';
            connectionStatus.className = `status ${connected ? 'success' : 'error'}`;

            zoneStatus.textContent = currentZone ? `In zone: ${currentZone}` : 'Not in any zone';
            muteStatus.textContent = `Muted: ${muted} | PTT Mode: ${pttEnabled}`;
        }

        // Update peer list
        function updatePeerList() {
            const peers = VoiceEngine.getPeers();
            peerCount.textContent = peers.length;

            if (peers.length === 0) {
                peerList.innerHTML = '<li class="peer-item">No peers connected</li>';
                return;
            }

            peerList.innerHTML = peers.map(peer => `
                <li class="peer-item">
                    <span>${peer.displayName || peer.userId || peer.peerId}</span>
                    <span>${peer.muted ? 'üîá' : 'üîä'} ${peer.speaking ? 'üó£Ô∏è' : ''}</span>
                </li>
            `).join('');
        }

        // Event Handlers
        btnInit.addEventListener('click', async () => {
            try {
                addLog('Initializing VoiceEngine...');
                await VoiceEngine.init('test_user_' + Math.random().toString(36).substr(2, 5), {
                    displayName: 'Test User',
                    signalServerUrl: 'ws://localhost:3002'
                });
                isInitialized = true;
                addLog('VoiceEngine initialized successfully', 'info');
                updateUI();

                // Setup callbacks
                VoiceEngine.onPeerConnect((data) => {
                    addLog(`Peer connected: ${data.peerId}`, 'info');
                    updatePeerList();
                });

                VoiceEngine.onPeerDisconnect((data) => {
                    addLog(`Peer disconnected: ${data.peerId}`, 'warn');
                    updatePeerList();
                });

                VoiceEngine.onAudioLevel((data) => {
                    const percentage = Math.round(data.level * 100);
                    audioMeter.style.width = percentage + '%';
                    vadStatus.textContent = `Speaking: ${data.speaking} | Level: ${percentage}% | dB: ${data.db}`;
                });

            } catch (err) {
                addLog('Failed to initialize: ' + err.message, 'error');
                console.error(err);
            }
        });

        btnDestroy.addEventListener('click', () => {
            VoiceEngine.destroy();
            isInitialized = false;
            pttEnabled = false;
            addLog('VoiceEngine destroyed', 'warn');
            updateUI();
            peerList.innerHTML = '<li class="peer-item">No peers connected</li>';
            peerCount.textContent = '0';
        });

        btnJoinEvents.addEventListener('click', () => {
            VoiceEngine.joinZone('events');
            addLog('Joined events zone', 'info');
            updateUI();
        });

        btnJoinMovies.addEventListener('click', () => {
            VoiceEngine.joinZone('movies');
            addLog('Joined movies zone', 'info');
            updateUI();
        });

        btnLeave.addEventListener('click', () => {
            const zone = VoiceEngine.getCurrentZone();
            if (zone) {
                VoiceEngine.leaveZone(zone);
                addLog(`Left zone: ${zone}`, 'warn');
                updateUI();
            }
        });

        btnToggleMute.addEventListener('click', () => {
            const muted = VoiceEngine.toggleMute();
            addLog(`Mute toggled: ${muted ? 'muted' : 'unmuted'}`, muted ? 'warn' : 'info');
            updateUI();
        });

        btnEnablePTT.addEventListener('click', () => {
            pttEnabled = !pttEnabled;
            VoiceEngine.setPushToTalk(pttEnabled);
            addLog(`Push-to-talk ${pttEnabled ? 'enabled' : 'disabled'}`, 'info');
            updateUI();
        });

        // Push-to-talk hold behavior
        btnPushToTalk.addEventListener('mousedown', () => {
            if (pttEnabled) {
                VoiceEngine.setPushToTalkActive(true);
                addLog('PTT activated', 'info');
            }
        });

        btnPushToTalk.addEventListener('mouseup', () => {
            if (pttEnabled) {
                VoiceEngine.setPushToTalkActive(false);
                addLog('PTT deactivated', 'info');
            }
        });

        btnPushToTalk.addEventListener('mouseleave', () => {
            if (pttEnabled) {
                VoiceEngine.setPushToTalkActive(false);
            }
        });

        // Touch support for PTT
        btnPushToTalk.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (pttEnabled) {
                VoiceEngine.setPushToTalkActive(true);
                addLog('PTT activated (touch)', 'info');
            }
        });

        btnPushToTalk.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (pttEnabled) {
                VoiceEngine.setPushToTalkActive(false);
                addLog('PTT deactivated (touch)', 'info');
            }
        });

        btnUpdatePos.addEventListener('click', () => {
            const x = parseFloat(document.getElementById('posX').value) || 0;
            const y = parseFloat(document.getElementById('posY').value) || 0;
            const z = parseFloat(document.getElementById('posZ').value) || 0;
            VoiceEngine.updatePosition(x, y, z);
            addLog(`Position updated: (${x}, ${y}, ${z})`, 'info');
        });

        proximityRadius.addEventListener('input', () => {
            radiusValue.textContent = proximityRadius.value + 'm';
        });

        btnSetRadius.addEventListener('click', () => {
            const radius = parseInt(proximityRadius.value);
            VoiceEngine.setProximityRadius(radius);
            addLog(`Proximity radius set to ${radius}m`, 'info');
        });

        btnClearLog.addEventListener('click', () => {
            log.innerHTML = '';
        });

        // Initial UI update
        updateUI();
        addLog('Voice Engine Test Page Loaded', 'info');
        addLog('Click "Initialize VoiceEngine" to start', 'info');
    </script>
</body>
</html>
